# 游戏数据分析报告使用指南

## 概述
基于飞书多维表格的专业游戏数据分析系统，自动生成结构化的每日分析报告并发送到飞书群组。

## 核心功能
- ✅ **日期自动校验**：自动确定昨日、前日数据
- ✅ **关键指标分析**：DAU、新增、收入、付费率对比
- ✅ **渠道表现分析**：各渠道数据对比 + 亮点分析
- ✅ **国家表现分析**：各国家数据对比 + 亮点分析
- ✅ **近7日趋势**：DAU、新增、收入、付费率趋势分析
- ✅ **智能发现**：自动识别关键业务问题
- ✅ **业务建议**：基于数据提供可执行建议
- ✅ **飞书推送**：自动发送到飞书群组

## 数据源配置

### 游戏基础数据
- **表格ID**: `tblM5x1uyjwffoBq`
- **视图ID**: `vew8YRRC3u`
- **用途**: 整体趋势分析、近7日趋势

### 游戏渠道数据
- **表格ID**: `tblBiiYpOdRGonPy`
- **视图ID**: `vew8YRRC3u`
- **用途**: 渠道对比、渠道亮点分析

### 游戏主要国家数据
- **表格ID**: `tblgx4cY7LvncsiJ`
- **视图ID**: `vew8YRRC3u`
- **用途**: 国家对比、国家亮点分析

## 快速开始

### 生成并发送报告
```bash
python scripts/daily_report_main.py
```

### 仅生成报告（不发送）
```bash
python scripts/generate_daily_report.py
```

### 查看数据原始记录
```bash
python scripts/multi_table_processor.py
```

## 报告结构

### 一、关键指标分析

#### 1. 昨日总览数据
```
昨日（2026-02-02）总览数据
- 总DAU：39,518
- 新增用户：1,748
- 总收入：$26,160.23
- 付费率：2.57%

对照前日（2026-02-01）变化：
- DAU：-1,649 (-4.0%)
- 新增用户：-492 (-22.0%)
- 总收入：-13,904.22 (-34.7%)
- 付费率：-0.59 (-18.7%)
```

#### 2. 渠道表现分析
```
渠道表现分析（2026-02-02）
| 渠道 | DAU | 新增用户 | 总收入 | 付费率 |
|------|-----|----------|--------|--------|
| EPIC | 3,113 | 147 | $1,963.81 | 2.73% |
| IOS | 3,127 | 230 | $2,771.77 | 3.04% |
| PC官包 | 20,906 | 214 | $8,903.05 | 1.77% |
| Steam | 8,348 | 679 | $7,653.70 | 3.59% |
| 安卓 | 6,158 | 492 | $4,867.90 | 2.84% |

渠道亮点：
- Steam渠道：付费率最高（3.59%）
- Steam渠道：新增用户最多（679）
- PC官包：DAU占比最高（52.9%），但付费率1.77%
```

#### 3. 国家表现分析
```
国家表现分析（2026-02-02）
| 国家 | DAU | 新增用户 | 总收入 | 付费率 |
|------|-----|----------|--------|--------|
| 其他 | 22,512 | 1,214 | $11,337.61 | 2.11% |
| 日本 | 7,012 | 112 | $4,365.03 | 2.52% |
| 美国 | 6,303 | 355 | $6,022.82 | 3.70% |
| 韩国 | 3,853 | 73 | $4,434.77 | 3.45% |

国家亮点：
- 美国：付费率最高（3.70%）
- 其他：DAU最高（22,512）
```

### 二、近七日趋势分析

```
1. DAU趋势（最近7天）
- 整体呈下降8.62%：从43,247至39,518

2. 新增用户趋势
- 整体呈下降31.56%：从2,554至1,748

3. 收入趋势
- 从$28,038.81至$26,160.23

4. 付费率趋势
- 波动范围：2.32% - 3.16%
- 昨日付费率2.57%，近7天平均值2.66%
- 昨日付费率低于平均值
```

### 🔍 关键发现
系统自动识别关键业务问题，例如：
1. PC官包 DAU占比52.9%但付费率仅1.77%
2. Steam渠道表现最佳：付费率3.59%，新增用户679

### 💡 业务建议
基于数据提供可执行建议，例如：
1. 优化PC官包付费转化策略
2. 加大Steam渠道投入
3. 建立关键指标预警机制

## 项目结构
```
.
├── config/
│   └── agent_llm_config.json          # Agent 配置
├── src/
│   ├── tools/
│   │   ├── feishu_bitable_tool.py    # 飞书多维表格工具
│   │   └── feishu_message_tool.py    # 飞书消息工具
│   └── storage/
│       └── memory/
│           └── memory_saver.py        # 记忆存储
└── scripts/
    ├── daily_report_main.py           # 主脚本：生成报告 + 发送飞书
    ├── generate_daily_report.py       # 报告生成核心逻辑
    ├── multi_table_processor.py       # 多表格数据处理器
    └── quick_test.py                  # 快速测试脚本
```

## 核心组件

### 1. MultiTableDataProcessor
多表格数据处理器，负责从飞书多维表格获取数据并解析。

**关键方法**:
- `fetch_data(table_id, view_id)`: 获取指定表格数据
- `parse_record(record)`: 解析单条记录
- `process_table_data(table_id, view_id, last_n)`: 处理表格数据

### 2. generate_report()
报告生成函数，包含完整的分析逻辑。

**功能**:
- 日期校验：自动确定昨日、前日
- 数据汇总：按分组汇总各维度数据
- 趋势分析：计算近7天趋势
- 亮点识别：自动找出最佳/最差表现

### 3. send_to_feishu()
飞书消息发送函数。

**功能**:
- 发送交互式卡片到飞书群组
- 支持 Markdown 格式渲染
- 自动处理发送结果

## 数据准确性保证

1. **真实数据源**: 所有数据来自飞书多维表格，拒绝编造
2. **代码层处理**: 数据解析和分析在代码层面完成，避免模型幻觉
3. **日期校验**: 自动验证数据日期，确保分析的是正确的数据
4. **明确时间范围**: 报告明确标注数据分析的时间范围
5. **数据验证**: 确保只使用实际存在的数据

## 定时任务配置

### 方式 1: 使用 crontab
```bash
# 编辑 crontab
crontab -e

# 添加定时任务（每天早上9点）
0 9 * * * cd /workspace/projects && python scripts/daily_report_main.py >> logs/daily_report.log 2>&1
```

### 方式 2: 使用 shell 脚本
```bash
# 运行分析脚本
bash scripts/run_daily_analysis.sh
```

## 常见问题

### Q1: 如何修改分析的数据表格？
编辑 `daily_report_main.py` 中的 `table_configs` 列表。

### Q2: 如何修改飞书机器人 webhook？
通过集成配置面板修改飞书消息集成的 webhook URL。

### Q3: 报告的数据准确性如何保证？
- 使用代码层处理数据，避免模型幻觉
- 自动日期校验，确保分析正确的数据
- 明确标注数据时间范围
- 只使用实际存在的数据

### Q4: 如何查看原始数据？
```bash
python scripts/multi_table_processor.py
```

## 更新日志

### v3.0 (2026-02-03)
- ✨ **新增日期校验**：自动确定昨日、前日数据
- ✨ **重构报告结构**：按照专业分析模板重新组织
- ✨ **增强渠道分析**：增加渠道亮点识别
- ✨ **增强国家分析**：增加国家亮点识别
- ✨ **优化趋势分析**：更清晰的近7日趋势展示
- ✨ **智能发现**：自动识别关键业务问题
- ✨ **业务建议**：基于数据提供可执行建议

### v2.0 (2026-02-03)
- ✨ 新增多表格支持：游戏基础数据、渠道数据、国家数据
- ✨ 优化数据准确性：代码层处理，避免模型幻觉
- 🔧 切换模型：从 doubao-seed 切换到 DeepSeek-V3

### v1.0 (初始版本)
- ✅ 基础数据分析功能
- ✅ 飞书多维表格集成
- ✅ 飞书消息推送

## 技术栈
- Python 3.12
- LangChain 1.0
- LangGraph
- 飞书多维表格集成
- 飞书消息集成
