# 二重螺旋游戏数据分析报告使用指南

## 概述
基于飞书多维表格的专业游戏数据分析系统，专为二重螺旋海外游戏项目设计，自动生成结构化的每日分析报告并发送到飞书群组。

## 业务场景
你是海外游戏项目二重螺旋的数据分析师，负责分析昨日数据和近期（七日）数据的变化趋势，并在日报结尾输出业务建议。

## 知识库
- **DAU**：游戏日活跃用户数（Daily Active Users）
- **ARPU**：平均每用户收入（Average Revenue Per User）= 总收入 / DAU
- **ARPPU**：平均每付费用户收入（Average Revenue Per Paying User）= 总收入 / 付费用户数
- **付费率**：付费用户数 / DAU

## 渠道维度
- **PC端渠道**：PC官包、Steam、EPIC
- **移动端渠道**：IOS、安卓

## 核心功能
- ✅ **日期自动校验**：自动确定昨日、前日数据
- ✅ **全指标分析**：DAU、新增、收入、付费用户、付费率、ARPU、ARPPU
- ✅ **渠道表现分析**：各渠道数据对比 + 平台分类 + 亮点分析
- ✅ **国家表现分析**：各国家数据对比 + 收入排名 + 亮点分析
- ✅ **近7日趋势分析**：6大维度的深度趋势分析
- ✅ **智能发现**：自动识别关键业务问题
- ✅ **业务建议**：基于数据提供可执行建议
- ✅ **飞书推送**：自动发送到飞书群组

## 数据源配置

### 游戏基础数据
- **表格ID**: `tblM5x1uyjwffoBq`
- **视图ID**: `vew8YRRC3u`
- **用途**: 整体趋势分析、近7日趋势

### 游戏渠道数据
- **表格ID**: `tblBiiYpOdRGonPy`
- **视图ID**: `vew8YRRC3u`
- **用途**: 渠道对比、平台对比、渠道亮点分析

### 游戏主要国家数据
- **表格ID**: `tblgx4cY7LvncsiJ`
- **视图ID**: `vew8YRRC3u`
- **用途**: 国家对比、收入排名、国家亮点分析

## 快速开始

### 生成并发送报告
```bash
python scripts/daily_report_main.py
```

### 仅生成报告（不发送）
```bash
python scripts/generate_daily_report.py
```

### 查看数据原始记录
```bash
python scripts/multi_table_processor.py
```

## 报告结构

### 一、关键指标分析

#### 1. 昨日总览数据
```
昨日（2026-02-02）总览数据
- DAU：39,518
- 新增用户：1,748
- 总收入：$26,160.23
- 付费用户数：1,016
- 付费率：2.57%
- ARPU：$0.66
- ARPPU：$25.75

对照前日（2026-02-01）变化：
- DAU：-1,649 (-4.0%)
- 新增用户：-492 (-22.0%)
- 总收入：-13,904.22 (-34.7%)
- 付费用户数：-283 (-21.8%)
- 付费率：-0.59% (-18.7%)
- ARPU：-0.31 (-32.0%)
- ARPPU：-5.09 (-16.5%)
```

#### 2. 渠道表现分析
```
渠道表现分析（2026-02-02）
| 渠道 | 平台 | DAU | 新增用户 | 总收入 | 付费用户 | 付费率 | ARPU | ARPPU |
|------|------|-----|----------|--------|----------|--------|------|-------|
| PC官包 | PC端 | 20,906 | 214 | $8,903.05 | 369 | 1.77% | $0.43 | $24.13 |
| Steam | PC端 | 8,348 | 679 | $7,653.70 | 300 | 3.59% | $0.92 | $25.51 |
| 安卓 | 移动端 | 6,158 | 492 | $4,867.90 | 175 | 2.84% | $0.79 | $27.82 |
| IOS | 移动端 | 3,127 | 230 | $2,771.77 | 95 | 3.04% | $0.89 | $29.18 |
| EPIC | PC端 | 3,113 | 147 | $1,963.81 | 85 | 2.73% | $0.63 | $23.10 |

渠道亮点分析：
- Steam：付费率最高（3.59%），付费转化效果最佳
- Steam：新增用户最多（679），用户获取能力强
- PC官包：DAU占比最高（52.9%），但付费率（1.77%）和ARPPU（$24.13）较低
- 平台对比：PC端DAU 32,367，ARPU $0.57；移动端DAU 9,285，ARPU $0.82
```

#### 3. 国家表现分析
```
国家表现分析（2026-02-02）
| 国家 | DAU | 新增用户 | 总收入 | 付费用户 | 付费率 | ARPU | ARPPU |
|------|-----|----------|--------|----------|--------|------|-------|
| 其他 | 22,512 | 1,214 | $11,337.61 | 474 | 2.11% | $0.50 | $23.92 |
| 美国 | 6,303 | 355 | $6,022.82 | 233 | 3.70% | $0.96 | $25.85 |
| 韩国 | 3,853 | 73 | $4,434.77 | 133 | 3.45% | $1.15 | $33.34 |
| 日本 | 7,012 | 112 | $4,365.03 | 177 | 2.52% | $0.62 | $24.66 |

国家亮点分析：
- 美国：付费率最高（3.70%），ARPPU达到$25.85，用户付费意愿强
- 其他：DAU最高（22,512），贡献收入$11,337.61，ARPU为$0.50
- 收入排名：第1名 - 其他（43.3%），第2名 - 美国（23.0%），第3名 - 韩国（17.0%）
```

### 二、近七日趋势分析

#### 1. DAU趋势分析
- 整体趋势：从43,247变化至39,518，整体呈下降8.62%
- 变化幅度：7天内DAU变化-3,729，日均变化约-533
- 详细变化：每日环比变化（标注显著变化）

#### 2. 新增用户趋势分析
- 整体趋势：从2,554变化至1,748，整体呈下降31.56%
- 持续下降：新增用户连续X天下降，降幅达XX%
- 判断结论：用户获取能力减弱/增强

#### 3. 收入趋势分析
- 整体趋势：从$28,038.81变化至$26,160.23，7天累计变化-6.7%
- 近期趋势：最近X天累计变化XX%
- 波动分析：收入波动较小/较大（波动幅度X%）

#### 4. 付费用户数趋势分析
- 整体趋势：从1,244变化至1,016，7天累计变化-18.3%
- 趋势判断：付费用户数呈上升/下降/稳定态势
- 对比分析：付费用户数变化 vs DAU变化

#### 5. 付费率趋势分析
- 波动范围：2.32% - 3.16%，波动幅度0.84个百分点
- 当前水平：昨日付费率2.57%，近7天平均值2.66%
- 趋势判断：昨日付费率高于/低于/接近平均水平
- 近期走势：付费率呈上升/下降/稳定趋势

#### 6. ARPU和ARPPU趋势分析
- ARPU趋势：昨日$0.66，7天平均值$0.74
  - 单用户付费能力提升/下降，高于/低于平均值X%
- ARPPU趋势：昨日$25.75，7天平均值$27.79
  - 付费用户付费意愿增强/减弱

### 🔍 关键发现
系统自动识别关键业务问题，例如：
1. 收入最近3天累计下降23.3%，变现能力下滑
2. PC官包 DAU占比高达52.9%但付费率仅1.77%
3. Steam渠道表现最佳：付费率3.59%，新增用户679
4. 付费用户数在7天中有X天下降，持续流失

### 💡 业务建议
基于数据提供可执行建议，例如：
1. 针对PC官包渠道优化付费转化策略
2. 加大Steam渠道投入，提升其DAU占比
3. 建立关键指标预警机制
4. 定期分析ARPU和ARPPU变化

## 项目结构
```
.
├── config/
│   └── agent_llm_config.json          # Agent 配置
├── docs/
│   └── daily_report_guide.md          # 使用指南（本文件）
├── src/
│   ├── tools/
│   │   ├── feishu_bitable_tool.py    # 飞书多维表格工具
│   │   └── feishu_message_tool.py    # 飞书消息工具
│   └── storage/
│       └── memory/
│           └── memory_saver.py        # 记忆存储
└── scripts/
    ├── daily_report_main.py           # 主脚本：生成报告 + 发送飞书
    ├── generate_daily_report.py       # 报告生成核心逻辑
    ├── multi_table_processor.py       # 多表格数据处理器
    └── quick_test.py                  # 快速测试脚本
```

## 核心组件

### 1. MultiTableDataProcessor
多表格数据处理器，负责从飞书多维表格获取数据并解析。

**关键方法**:
- `fetch_data(table_id, view_id)`: 获取指定表格数据
- `parse_record(record)`: 解析单条记录
- `process_table_data(table_id, view_id, last_n)`: 处理表格数据

### 2. generate_report()
报告生成函数，包含完整的分析逻辑。

**功能**:
- 日期校验：自动确定昨日、前日
- 数据汇总：按分组汇总各维度数据
- 趋势分析：计算近7天趋势（6大维度）
- 亮点识别：自动找出最佳/最差表现
- 智能建议：基于数据自动生成建议

### 3. send_to_feishu()
飞书消息发送函数。

**功能**:
- 发送交互式卡片到飞书群组
- 支持 Markdown 格式渲染
- 自动处理发送结果

## 数据准确性保证

1. **真实数据源**: 所有数据来自飞书多维表格，拒绝编造
2. **代码层处理**: 数据解析和分析在代码层面完成，避免模型幻觉
3. **日期校验**: 自动验证数据日期，确保分析的是正确的数据
4. **明确时间范围**: 报告明确标注数据分析的时间范围
5. **数据验证**: 确保只使用实际存在的数据
6. **精度控制**: 金额保留2位小数，百分比保留2位小数

## 定时任务配置

### 方式 1: 使用 crontab
```bash
# 编辑 crontab
crontab -e

# 添加定时任务（每天早上9点）
0 9 * * * cd /workspace/projects && python scripts/daily_report_main.py >> logs/daily_report.log 2>&1
```

### 方式 2: 使用 shell 脚本
```bash
# 运行分析脚本
bash scripts/run_daily_analysis.sh
```

## 常见问题

### Q1: 如何修改分析的数据表格？
编辑 `daily_report_main.py` 中的 `table_configs` 列表。

### Q2: 如何修改飞书机器人 webhook？
通过集成配置面板修改飞书消息集成的 webhook URL。

### Q3: 报告的数据准确性如何保证？
- 使用代码层处理数据，避免模型幻觉
- 自动日期校验，确保分析正确的数据
- 明确标注数据时间范围
- 只使用实际存在的数据
- 精确的数值格式化（金额保留2位小数）

### Q4: 如何查看原始数据？
```bash
python scripts/multi_table_processor.py
```

### Q5: ARPU和ARPPU的区别是什么？
- **ARPU**（Average Revenue Per User）：总收入/DAU，反映所有用户的平均付费能力
- **ARPPU**（Average Revenue Per Paying User）：总收入/付费用户数，反映付费用户的平均付费水平

## 更新日志

### v4.0 (2026-02-03) - 最终优化版本
- ✨ **新增指标**：付费用户数、ARPU、ARPPU
- ✨ **增强表格**：渠道表和国家表增加平台、付费用户、ARPU、ARPPU列
- ✨ **趋势分析**：新增付费用户数趋势、ARPU/ARPPU趋势分析
- ✨ **深度分析**：趋势分析内容翻倍，包含趋势判断、对比分析、波动分析
- ✨ **业务场景**：明确二重螺旋海外游戏项目背景
- ✨ **知识库**：补充DAU、ARPU、ARPPU定义和渠道分类
- 🐛 **修复精度**：解决浮点数精度问题，金额保留2位小数

### v3.0 (2026-02-03)
- ✨ 新增日期校验
- ✨ 重构报告结构
- ✨ 增强渠道/国家分析
- ✨ 优化趋势分析

### v2.0 (2026-02-03)
- ✨ 新增多表格支持
- ✨ 优化数据准确性

### v1.0 (初始版本)
- ✅ 基础数据分析功能
- ✅ 飞书多维表格集成
- ✅ 飞书消息推送

## 技术栈
- Python 3.12
- LangChain 1.0
- LangGraph
- 飞书多维表格集成
- 飞书消息集成

## 联系方式
如果在分析中遇到任何问题，请联系我更新补充业务场景和知识库。
