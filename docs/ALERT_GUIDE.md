# 收入异常报警功能使用指南

## 功能说明
当昨日收入较前日下降超过 **30%** 时，系统会自动在飞书日报中添加报警信息，并@相关人员提醒关注。

## 配置方式

### 方式一：配置要@的特定用户（推荐）

1. **获取飞书用户的 User ID**
   - 在飞书群组中，点击要@的用户头像
   - 查看该用户的个人信息
   - 找到并复制 `User ID`（格式类似：`ou_xxxxxxxxxxxxxxxx`）

2. **配置 User ID**
   - 编辑 `scripts/start_scheduler.sh` 文件
   - 修改 `ALERT_USER_ID` 变量的值：
     ```bash
     # 设置收入异常报警要@的用户ID（留空则@所有人）
     export ALERT_USER_ID="ou_1234567890abcdef"
     ```
   - 保存文件

3. **重启调度器**
   ```bash
   bash scripts/stop_scheduler.sh
   bash scripts/start_scheduler.sh
   ```

### 方式二：@所有人

如果不需要@特定用户，可以保持 `ALERT_USER_ID` 为空字符串，这样会@所有人：

```bash
export ALERT_USER_ID=""
```

## 报警效果

### 未触发报警（收入正常或下降不足30%）
```
**昨日（2026-02-05）总览数据**
- DAU：36,010
- 新增用户：1,332
- 总收入：$23,689.53
...
对照前日（2026-02-04）变化：
- 总收入：$17,432.09 → $23,689.53 (+6,257.44, +35.9%)
...
**变化原因细拆：**
- 收入增长29%来自Steam：该渠道收入增长$1,821.16，占总收入增长的29%
...
```

### 触发报警（收入下降超过30%）
```
**昨日（2026-02-05）总览数据**
- DAU：36,010
- 新增用户：1,332
- 总收入：$23,689.53
...
对照前日（2026-02-04）变化：
- 总收入：$47,379.06 → $23,689.53 (-23,689.53, -50.00%)
...
**变化原因细拆：**
- 收入下降29%来自Steam：该渠道收入下降$1,821.16，占总收入下降的29%
...

---

⚠️ **收入异常报警**
<at user_id="ou_1234567890abcdef">@相关同学</at> 请注意！
昨日收入较前日下降 **50.00%**，请及时关注！
前日收入：$47,379.06
昨日收入：$23,689.53
下降金额：$23,689.53
```

## 测试报警功能

运行测试脚本，模拟收入下降50%的情况：

```bash
python scripts/test_alert.py
```

该脚本会：
1. 获取昨日的真实收入数据
2. 模拟前日收入为昨日的2倍（即收入下降50%）
3. 显示报警信息格式
4. 验证 @功能是否正常

## 注意事项

1. **报警阈值**：默认为 -30%，即收入下降超过30%时触发报警
2. **User ID 格式**：飞书 User ID 格式通常为 `ou_xxxxxxxxxxxxxxxx`
3. **多用户提醒**：如需@多人，需要修改代码逻辑（当前版本仅支持@单个人或@所有人）
4. **飞书权限**：确保机器人有@群成员的权限

## 常见问题

**Q: 为什么没有收到@提醒？**
A: 请检查：
- User ID 是否正确
- 机器人是否有@群成员的权限
- 收入是否真的下降了超过30%

**Q: 如何修改报警阈值？**
A: 编辑 `scripts/generate_simple_report.py` 文件，找到第340行：
```python
if income_change_pct < -30:  # 修改这个数字
```

**Q: 可以在移动端飞书收到报警吗？**
A: 可以，飞书消息中的@提醒会在移动端推送通知
