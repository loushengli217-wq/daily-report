# 收入异常报警功能使用指南

## 功能说明
当昨日收入较前日下降超过 **30%** 时，系统会自动在飞书日报中添加报警信息，提醒群成员关注。

## ⚠️ 重要说明

### 关于@功能的限制
**飞书Webhook机器人无法真正@群成员**

由于飞书平台的限制，自定义Webhook机器人没有权限使用@功能（包括@所有人或@特定人）。因此我们采用了醒目的文本提示方式来实现报警效果。

### 替代方案
使用醒目的格式来提醒群成员：
- 🚨 警报图标
- 粗体标题"收入异常报警"
- 粗体提示"【请所有人注意】"
- 详细的收入下降数据

这种方式虽然不会触发飞书的推送通知，但在消息内容中非常醒目，足以引起群成员注意。

## 报警效果

### 未触发报警（收入正常或下降不足30%）
```
**昨日（2026-02-05）总览数据**
- DAU：36,010
- 新增用户：1,332
- 总收入：$23,689.53
...
对照前日（2026-02-04）变化：
- 总收入：$17,432.09 → $23,689.53 (+6,257.44, +35.9%)
...
**变化原因细拆：**
- 收入增长29%来自Steam：该渠道收入增长$1,821.16，占总收入增长的29%
...
```

### 触发报警（收入下降超过30%）
```
**昨日（2026-02-05）总览数据**
- DAU：36,010
- 新增用户：1,332
- 总收入：$23,689.53
...
对照前日（2026-02-04）变化：
- 总收入：$47,379.06 → $23,689.53 (-23,689.53, -50.00%)
...
**变化原因细拆：**
- 收入下降29%来自Steam：该渠道收入下降$1,821.16，占总收入下降的29%
...

---

🚨 **收入异常报警**

**【请所有人注意】**
昨日收入较前日下降 **50.00%**，请及时关注！
前日收入：$47,379.06
昨日收入：$23,689.53
下降金额：$23,689.53
```

## 如何实现真正的@功能

如果您需要实现真正的@功能（触发推送通知），有以下方案：

### 方案一：使用飞书官方机器人（推荐）
1. 在飞书开放平台创建应用
2. 获取app_access_token
3. 申请消息推送权限
4. 使用官方API发送消息并@成员

这需要较多的开发工作和飞书企业认证。

### 方案二：结合飞书群机器人
1. 创建飞书群机器人
2. 配置机器人权限
3. 使用机器人API发送消息

这也需要在飞书群组中进行配置。

### 方案三：当前方案（已实现）
使用醒目的文本提示，虽然不会触发推送通知，但足以提醒查看日报的成员。

## 测试报警功能

运行测试脚本，模拟收入下降50%的情况：

```bash
python scripts/test_alert_with_send.py
```

该脚本会：
1. 获取昨日的真实收入数据
2. 模拟前日收入为昨日的2倍（即收入下降50%）
3. 显示报警信息格式
4. 发送到飞书群组验证效果

## 注意事项

1. **报警阈值**：默认为 -30%，即收入下降超过30%时触发报警
2. **@功能限制**：Webhook机器人无法使用@功能，使用文本替代
3. **醒目提示**：报警信息使用🚨图标和粗体，非常醒目
4. **群成员注意**：建议群成员养成每日查看日报的习惯

## 常见问题

**Q: 为什么不能@所有人？**
A: 飞书Webhook机器人没有@权限，这是平台限制。当前使用醒目的文本提示作为替代方案。

**Q: 如何让报警更有效？**
A: 建议：
1. 要求团队成员每日查看日报
2. 在群公告中说明日报的重要性
3. 对于紧急情况，可以手动@相关负责人
4. 设置日报定时提醒（飞书群功能）

**Q: 可以修改报警阈值吗？**
A: 可以。编辑 `scripts/generate_simple_report.py` 文件，找到：
```python
if income_change_pct < -30:  # 修改这个数字
```

**Q: 可以在移动端看到报警吗？**
A: 可以，日报消息会正常显示在移动端飞书中，但不会触发推送通知（因为不是真正的@）。需要群成员主动查看。
